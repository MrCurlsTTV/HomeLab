---
# File: Ansible\roles\rke2\tasks\bootstrap.yml
# Bootstrap essential services after all cluster nodes are ready

- name: Wait for all cluster nodes to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: /etc/rancher/rke2/rke2.yaml
    wait: true
    wait_timeout: 600
    wait_condition:
      type: Ready
      status: "True"
  register: cluster_nodes

- name: Display cluster node status
  debug:
    msg: "Cluster has {{ cluster_nodes.resources | length }} ready nodes"

- name: Wait for all worker nodes to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: /etc/rancher/rke2/rke2.yaml
    label_selectors:
      - "node.kubernetes.io/role=worker"
  register: worker_nodes
  until: worker_nodes.resources | length >= (groups['rke2_agents'] | length)
  retries: 30
  delay: 10

- name: Display worker node status
  debug:
    msg: "{{ worker_nodes.resources | length }} worker nodes ready (expected: {{ groups['rke2_agents'] | length }})"

# === ISTIO BOOTSTRAP ===
- name: Apply Istio namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: istio-system
    kubeconfig: /etc/rancher/rke2/rke2.yaml

- name: Apply Istio manifests
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    kubeconfig: /etc/rancher/rke2/rke2.yaml
  with_fileglob:
    - "/opt/kubernetes-bootstrap/istio/*.yaml"
  register: istio_apply
  ignore_errors: true

- name: Wait for Istio to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: istiod
    namespace: istio-system
    kubeconfig: /etc/rancher/rke2/rke2.yaml
    wait: true
    wait_timeout: 300
    wait_condition:
      type: Available
      status: "True"
  ignore_errors: true

# === ARGOCD BOOTSTRAP ===
- name: Apply ArgoCD namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: argocd
    kubeconfig: /etc/rancher/rke2/rke2.yaml

- name: Apply ArgoCD bootstrap manifests
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
    kubeconfig: /etc/rancher/rke2/rke2.yaml
  with_fileglob:
    - "/opt/kubernetes-bootstrap/argocd/*.yaml"
  register: argocd_apply

- name: Wait for ArgoCD server to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: argocd-server
    namespace: argocd
    kubeconfig: /etc/rancher/rke2/rke2.yaml
    wait: true
    wait_timeout: 600
    wait_condition:
      type: Available
      status: "True"
  ignore_errors: true

- name: Get ArgoCD admin password (if available)
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" --kubeconfig /etc/rancher/rke2/rke2.yaml | base64 -d
  register: argocd_password
  changed_when: false
  ignore_errors: true

- name: Display ArgoCD admin password
  debug:
    msg: "ArgoCD Admin Password: {{ argocd_password.stdout | default('Not available yet') }}"
  when: argocd_password.stdout is defined

- name: Display bootstrap completion status
  debug:
    msg: |
      Kubernetes Bootstrap Complete:
      - Istio: {{ 'APPLIED' if istio_apply is succeeded else 'FAILED' }}
      - ArgoCD: {{ 'APPLIED' if argocd_apply is succeeded else 'FAILED' }}
      - Worker Nodes Ready: {{ worker_nodes.resources | length }}/{{ groups['rke2_agents'] | length }}
      
      Next steps:
      - Access ArgoCD at: https://argocd.mrcurls.org
      - Use admin password above to login
      - ArgoCD will manage additional applications
